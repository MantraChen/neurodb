<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroDB Kernel Console</title>
    <style>
        :root {
            /* Professional Dark Theme (Linear / GitHub Inspired) */
            --bg-body: #0d1117;
            --bg-panel: #161b22;
            --bg-input: #010409;
            --border: #30363d;
            --border-active: #8b949e;
            
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --text-tertiary: #6e7681;

            --accent: #1f6feb;      /* Action Blue */
            --success: #238636;     /* Stable Green */
            --warning: #d29922;     /* Warn */
            --danger: #da3633;      /* Destructive */
            
            --font-ui: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            --font-mono: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
        }

        * { box-sizing: border-box; outline: none; }

        body {
            background-color: var(--bg-body);
            color: var(--text-primary);
            font-family: var(--font-ui);
            font-size: 13px;
            margin: 0;
            padding: 20px;
            line-height: 1.5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }

        h1 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            letter-spacing: -0.02em;
            color: var(--text-primary);
        }
        
        .badge {
            font-family: var(--font-mono);
            font-size: 11px;
            background: var(--border);
            padding: 2px 6px;
            border-radius: 4px;
            color: var(--text-secondary);
            margin-left: 8px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            font-family: var(--font-mono);
            font-size: 11px;
            color: var(--success);
        }
        .dot { width: 6px; height: 6px; background: var(--success); border-radius: 50%; margin-right: 6px; }

        /* Metrics Grid */
        .metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px 16px;
        }

        .metric-label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; }
        .metric-value { font-family: var(--font-mono); font-size: 20px; color: var(--text-primary); margin-top: 4px; }
        .metric-sub { font-size: 11px; color: var(--text-tertiary); margin-top: 2px; }

        /* Main Layout */
        .layout { display: flex; gap: 20px; flex: 1; min-height: 0; }
        .col-left { width: 340px; display: flex; flex-direction: column; gap: 12px; overflow-y: auto; }
        .col-right { flex: 1; display: flex; flex-direction: column; gap: 12px; min-width: 0; }

        /* Control Panels */
        .panel {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 16px;
        }

        .panel-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
        }

        /* Forms */
        .form-row { display: flex; gap: -1px; margin-bottom: 8px; }
        
        input {
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 6px 10px;
            font-family: var(--font-mono);
            font-size: 12px;
            border-radius: 4px;
            width: 100%;
            transition: border 0.1s;
        }
        input:focus { border-color: var(--accent); z-index: 2; }
        
        .group-input input:first-child { border-top-right-radius: 0; border-bottom-right-radius: 0; }
        .group-input input:not(:first-child) { border-radius: 0; margin-left: -1px; }
        .group-input button { border-top-left-radius: 0; border-bottom-left-radius: 0; margin-left: -1px; }

        button {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 500;
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
        }
        button:hover { background: #21262d; border-color: var(--border-active); }
        button:active { background: #292e36; }
        
        .btn-primary { background: var(--accent); border-color: rgba(255,255,255,0.1); color: white; }
        .btn-primary:hover { background: #1a5cce; }
        
        .btn-danger { color: var(--danger); border-color: var(--border); }
        .btn-danger:hover { color: #ff6a67; border-color: var(--danger); }

        .btn-block { width: 100%; text-align: center; }

        /* Terminal / Logs */
        .terminal {
            background: #0d1117;
            border: 1px solid var(--border);
            border-radius: 6px;
            flex: 1;
            padding: 12px;
            font-family: var(--font-mono);
            font-size: 11px;
            overflow-y: auto;
            color: var(--text-secondary);
        }
        .log-line { margin-bottom: 4px; display: flex; }
        .ts { color: var(--text-tertiary); margin-right: 10px; user-select: none; }
        .msg-info { color: var(--text-primary); }
        .msg-success { color: var(--success); }
        .msg-error { color: var(--danger); }
        .msg-sys { color: var(--accent); }

        /* Benchmark Bars */
        .bench-row { display: flex; align-items: center; margin-bottom: 8px; font-size: 11px; }
        .bench-label { width: 60px; color: var(--text-secondary); }
        .bench-track { flex: 1; height: 4px; background: #21262d; margin: 0 10px; border-radius: 2px; overflow: hidden; }
        .bench-fill { height: 100%; background: var(--text-secondary); width: 0%; transition: width 0.5s ease; }
        .bench-fill.neuro { background: var(--success); }
        .bench-val { width: 70px; text-align: right; font-family: var(--font-mono); }
    </style>
</head>
<body>

    <header>
        <h1>NeuroDB <span class="badge">v2.1 Kernel</span></h1>
        <div class="status-indicator"><div class="dot"></div>System Operational</div>
    </header>

    <div class="metrics">
        <div class="metric-card">
            <div class="metric-label">Workload Mode</div>
            <div class="metric-value" id="modeVal">--</div>
            <div class="metric-sub">Optimizer Status</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">MemTable Entries</div>
            <div class="metric-value" id="memVal">0</div>
            <div class="metric-sub">Buffered Records</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">LSM Segments</div>
            <div class="metric-value" id="modelVal">0</div>
            <div class="metric-sub">Compaction Level 0</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">R/W Ratio</div>
            <div class="metric-value" id="rwVal">0.00</div>
            <div class="metric-sub">Bloom Filter: Active</div>
        </div>
    </div>

    <div class="layout">
        <div class="col-left">
            
            <div class="panel">
                <div class="panel-title">Write Operations</div>
                <div class="form-row group-input">
                    <input type="number" id="putKey" placeholder="ID">
                    <input type="text" id="putVal" placeholder="Payload">
                    <button onclick="doPut()">Put</button>
                </div>
                <button class="btn-block" onclick="triggerIngest()">Batch Ingest (50k)</button>
            </div>

            <div class="panel">
                <div class="panel-title">Spatial Indexing (Z-Order)</div>
                <div class="form-row group-input">
                    <input type="number" id="mx" placeholder="X" value="100">
                    <input type="number" id="my" placeholder="Y" value="200">
                    <input type="number" id="mz" placeholder="Z" value="50">
                    <button class="btn-primary" onclick="doMoCap()">Track</button>
                </div>
            </div>

            <div class="panel">
                <div class="panel-title">Read Operations</div>
                <div class="form-row group-input" style="margin-bottom: 12px;">
                    <input type="number" id="getKey" placeholder="Point Lookup ID...">
                    <button onclick="doGet()">Get</button>
                </div>
                
                <div class="panel-title" style="margin-top: 15px; font-size: 11px; color: var(--text-secondary);">RANGE SCAN</div>
                <div class="form-row group-input">
                    <input type="number" id="scanStart" placeholder="Start Key">
                    <input type="number" id="scanEnd" placeholder="End Key">
                    <button onclick="doScan()">Scan</button>
                </div>
            </div>

            <div class="panel">
                <div class="panel-title">Kernel Admin</div>
                <button class="btn-block" onclick="downloadCSV()">Export Diagnostics</button>
                <button class="btn-block btn-danger" onclick="resetDB()" style="margin-top: 8px;">Reset Kernel</button>
            </div>
        </div>

        <div class="col-right">
            <div class="panel" style="padding-bottom: 8px;">
                <div class="panel-title">
                    Latency Benchmark
                    <span id="speedupVal" style="color: var(--success); font-family: var(--font-mono);">0.00x Speedup</span>
                </div>
                <div class="bench-row">
                    <div class="bench-label">B-Tree</div>
                    <div class="bench-track"><div class="bench-fill" id="barB"></div></div>
                    <div class="bench-val" id="valB">--</div>
                </div>
                <div class="bench-row">
                    <div class="bench-label" style="color: var(--success);">NeuroDB</div>
                    <div class="bench-track"><div class="bench-fill neuro" id="barAI"></div></div>
                    <div class="bench-val" id="valAI">--</div>
                </div>
                <button class="btn-primary btn-block" onclick="runBenchmark()" id="btnBench" style="margin-top:10px;">Execute Performance Test</button>
            </div>

            <div class="terminal" id="console">
                <div class="log-line"><span class="ts">SYSTEM</span><span class="msg-info">Kernel initialized. Waiting for instruction.</span></div>
            </div>
        </div>
    </div>

    <script>
        // Logger
        function log(msg, type = 'info') {
            const el = document.getElementById('console');
            const now = new Date().toISOString().split('T')[1].slice(0,8);
            let cls = 'msg-info';
            if (type === 'err') cls = 'msg-error';
            if (type === 'ok') cls = 'msg-success';
            if (type === 'sys') cls = 'msg-sys';
            
            const row = document.createElement('div');
            row.className = 'log-line';
            row.innerHTML = `<span class="ts">${now}</span><span class="${cls}">${msg}</span>`;
            el.appendChild(row);
            el.scrollTop = el.scrollHeight;
        }

        // Stats Polling
        async function updateStats() {
            try {
                const res = await fetch('/api/stats');
                if (!res.ok) return;
                const data = await res.json();
                
                document.getElementById('memVal').innerText = data.memtable_record_count.toLocaleString();
                document.getElementById('modelVal').innerText = data.learned_indexes_count;
                document.getElementById('rwVal').innerText = parseFloat(data.rw_ratio).toFixed(2);
                
                const modeEl = document.getElementById('modeVal');
                if (data.mode.includes("AI")) {
                    modeEl.innerText = "AI-Optimized";
                    modeEl.style.color = "var(--success)";
                } else {
                    modeEl.innerText = "LSM-Write";
                    modeEl.style.color = "var(--text-primary)";
                }
            } catch(e) {}
        }
        setInterval(updateStats, 1000);

        // API Calls
        async function doPut() {
            const k = parseInt(document.getElementById('putKey').value);
            const v = document.getElementById('putVal').value;
            if(!k) return;
            try {
                await fetch('/api/put', { method:'POST', body: JSON.stringify({key:k, value:v})});
                log(`Write: Key=${k}`, 'ok');
                document.getElementById('putKey').value = k+1;
            } catch(e) { log(e, 'err'); }
        }

        async function triggerIngest() {
            if(!confirm("Initiate batch ingestion (50k records)?")) return;
            log("Starting ingestion process...", 'sys');
            try {
                await fetch('/api/ingest', { method:'POST'});
                // Polling for completion log simulation
                setTimeout(() => log("Ingestion complete. Flushing MemTable.", 'ok'), 4000);
            } catch(e) { log(e, 'err'); }
        }

        async function doMoCap() {
            const x = parseInt(document.getElementById('mx').value);
            const y = parseInt(document.getElementById('my').value);
            const z = parseInt(document.getElementById('mz').value);
            try {
                const res = await fetch('/api/mocap/put', { method:'POST', body: JSON.stringify({x,y,z, data:"Frame"})});
                const d = await res.json();
                log(`Spatial Index: (${x},${y},${z}) -> Z-Key: ${d.spatial_key}`, 'sys');
                document.getElementById('mx').value = x+1;
            } catch(e) { log(e, 'err'); }
        }

        async function doGet() {
            const k = document.getElementById('getKey').value;
            if(!k) return;
            const start = performance.now();
            try {
                const res = await fetch(`/api/get?key=${k}`);
                const d = await res.json();
                if(res.ok) log(`Query Hit: Key=${k} (${d.latency_ns}ns)`, 'ok');
                else log(`Query Miss: Key=${k} (Filtered)`, 'err');
            } catch(e) { log(`Error querying key ${k}`, 'err'); }
        }

        async function doScan() {
            const s = document.getElementById('scanStart').value;
            const e = document.getElementById('scanEnd').value;
            if(!s || !e) return;
            
            log(`Scanning range [${s}, ${e}]...`, 'sys');
            try {
                const res = await fetch(`/api/scan?start=${s}&end=${e}`);
                const d = await res.json();
                log(`Scan Result: Found ${d.count} records.`, 'ok');
                if(d.count > 0 && d.count < 10) {
                     // If small result, print keys
                     const keys = d.data.map(r => r.Key).join(", ");
                     log(`> Keys: [${keys}]`, 'info');
                }
            } catch(e) { log(e, 'err'); }
        }

        async function runBenchmark() {
            const btn = document.getElementById('btnBench');
            btn.innerText = "Running..."; btn.disabled = true;
            try {
                const res = await fetch('/api/benchmark');
                const d = await res.json();
                
                document.getElementById('valB').innerText = d.btree_avg_ns;
                document.getElementById('valAI').innerText = d.ai_avg_ns;
                document.getElementById('speedupVal').innerText = d.speedup + " Speedup";
                
                const max = Math.max(parseFloat(d.btree_avg_ns), parseFloat(d.ai_avg_ns));
                document.getElementById('barB').style.width = (parseFloat(d.btree_avg_ns)/max*100) + "%";
                document.getElementById('barAI').style.width = (parseFloat(d.ai_avg_ns)/max*100) + "%";
                
                log(`Benchmark: ${d.speedup} speedup achieved.`, 'sys');
            } catch(e) { log(e, 'err'); }
            finally { btn.innerText = "Execute Performance Test"; btn.disabled = false; }
        }

        function downloadCSV() { window.location.href = "/api/export"; }
        
        async function resetDB() {
            if(!confirm("Confirm Kernel Reset? Data will be wiped.")) return;
            await fetch('/api/reset');
            log("Kernel state reset.", 'sys');
            updateStats();
        }
    </script>
</body>
</html>