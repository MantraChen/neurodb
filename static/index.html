<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroDB Kernel Console</title>
    <style>
        :root {
            /* Professional Dark Theme (GitHub / VScode Inspired) */
            --bg-body: #0d1117;
            --bg-panel: #161b22;
            --bg-input: #010409;
            --border: #30363d;
            --border-active: #8b949e;
            
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --text-tertiary: #6e7681;

            --accent: #1f6feb;      /* Action Blue */
            --success: #238636;     /* Stable Green */
            --warning: #d29922;     /* Warn */
            --danger: #da3633;      /* Destructive */
            
            --font-ui: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            --font-mono: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
        }

        * { box-sizing: border-box; outline: none; }

        body {
            background-color: var(--bg-body);
            color: var(--text-primary);
            font-family: var(--font-ui);
            font-size: 13px;
            margin: 0;
            padding: 20px;
            line-height: 1.5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
            flex-shrink: 0;
        }

        h1 { margin: 0; font-size: 16px; font-weight: 600; color: var(--text-primary); letter-spacing: -0.02em; }
        .badge { font-family: var(--font-mono); font-size: 11px; background: var(--border); padding: 2px 6px; border-radius: 4px; color: var(--text-secondary); margin-left: 8px; }
        .badge-live { color: var(--success); border: 1px solid var(--success); background: rgba(35, 134, 54, 0.1); }
        
        .status-indicator { display: flex; align-items: center; font-family: var(--font-mono); font-size: 11px; color: var(--text-secondary); }
        .dot { width: 6px; height: 6px; background: var(--success); border-radius: 50%; margin-right: 6px; }

        /* Metrics Grid - Updated to 6 columns for Sharding info */
        .metrics {
            display: grid;
            grid-template-columns: repeat(6, 1fr); 
            gap: 12px;
            margin-bottom: 20px;
            flex-shrink: 0;
        }

        .metric-card {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px 16px;
        }

        .metric-label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; }
        .metric-value { font-family: var(--font-mono); font-size: 20px; color: var(--text-primary); margin-top: 4px; }
        .metric-sub { font-size: 11px; color: var(--text-tertiary); margin-top: 2px; }

        /* Highlight for the Queue */
        .val-queue { color: var(--warning); }

        /* Main Layout */
        .layout { display: flex; gap: 20px; flex: 1; min-height: 0; }
        .col-left { width: 340px; display: flex; flex-direction: column; gap: 12px; overflow-y: auto; padding-right: 4px; }
        .col-right { flex: 1; display: flex; flex-direction: column; gap: 12px; min-width: 0; overflow-y: auto; padding-right: 4px; }

        /* Panels */
        .panel {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 16px;
        }

        .panel-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Inputs & Buttons */
        .form-row { display: flex; gap: -1px; margin-bottom: 8px; }
        .group-input input:first-child { border-top-right-radius: 0; border-bottom-right-radius: 0; }
        .group-input input:not(:first-child) { border-radius: 0; margin-left: -1px; }
        .group-input button { border-top-left-radius: 0; border-bottom-left-radius: 0; margin-left: -1px; }

        input {
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 6px 10px;
            font-family: var(--font-mono);
            font-size: 12px;
            border-radius: 4px;
            width: 100%;
            transition: border 0.1s;
        }
        input:focus { border-color: var(--accent); z-index: 2; }

        button {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 500;
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
            transition: background 0.1s;
        }
        button:hover { background: #21262d; border-color: var(--border-active); }
        button:active { background: #292e36; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .btn-primary { background: var(--accent); border-color: rgba(255,255,255,0.1); color: white; }
        .btn-primary:hover { background: #1a5cce; }
        .btn-danger { color: var(--danger); border-color: var(--border); }
        .btn-danger:hover { color: #ff6a67; border-color: var(--danger); background: rgba(218, 54, 51, 0.1); }
        .btn-block { width: 100%; text-align: center; }

        /* Terminal */
        .terminal {
            background: #0d1117;
            border: 1px solid var(--border);
            border-radius: 6px;
            flex: 1;
            padding: 12px;
            font-family: var(--font-mono);
            font-size: 11px;
            overflow-y: auto;
            color: var(--text-secondary);
            min-height: 150px;
        }
        .log-line { margin-bottom: 4px; display: flex; }
        .ts { color: var(--text-tertiary); margin-right: 10px; user-select: none; flex-shrink: 0; }
        .msg-info { color: var(--text-primary); }
        .msg-success { color: var(--success); }
        .msg-error { color: var(--danger); }
        .msg-sys { color: var(--accent); }

        /* Visualization Elements */
        .bench-row { display: flex; align-items: center; margin-bottom: 8px; font-size: 11px; }
        .bench-label { width: 60px; color: var(--text-secondary); }
        .bench-track { flex: 1; height: 4px; background: #21262d; margin: 0 10px; border-radius: 2px; overflow: hidden; }
        .bench-fill { height: 100%; background: var(--text-secondary); width: 0%; transition: width 0.5s ease; }
        .bench-fill.neuro { background: var(--success); }
        .bench-val { width: 70px; text-align: right; font-family: var(--font-mono); }

        #heatCanvas { width: 100%; height: 200px; background: #010409; border: 1px solid var(--border); border-radius: 4px; margin-top: 10px; }
        
        /* Scrollbar polish */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #484f58; }
    </style>
</head>
<body>

    <header>
        <h1>NeuroDB <span class="badge badge-live">v2.5 WAL-Core</span></h1>
        <div class="status-indicator">
            <div class="dot"></div>
            <span>Engine: Sharded + WAL Persistence</span>
        </div>
    </header>

    <div class="metrics">
        <div class="metric-card">
            <div class="metric-label">Workload Mode</div>
            <div class="metric-value" id="modeVal">--</div>
            <div class="metric-sub">Optimizer Status</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">WAL Buffer</div>
            <div class="metric-value val-queue" id="queueVal">0</div>
            <div class="metric-sub">Pending Writes</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Total MemTable</div>
            <div class="metric-value" id="memVal">0</div>
            <div class="metric-sub">Records in RAM</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Active Shards</div>
            <div class="metric-value" id="shardVal" style="color: var(--accent);">--</div>
            <div class="metric-sub">Parallel Units</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Total Segments</div>
            <div class="metric-value" id="modelVal">0</div>
            <div class="metric-sub">Learned Indexes</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">R/W Ratio</div>
            <div class="metric-value" id="rwVal">0.00</div>
            <div class="metric-sub">Global Stat</div>
        </div>
    </div>

    <div class="layout">
        <div class="col-left">
            
            <div class="panel">
                <div class="panel-title">Write Operations</div>
                <div class="form-row group-input">
                    <input type="number" id="putKey" placeholder="ID">
                    <input type="text" id="putVal" placeholder="Payload">
                    <button onclick="doPut()">Put</button>
                </div>
                <button class="btn-block" onclick="triggerIngest()">Start Batch Ingest (50k)</button>
            </div>

            <div class="panel">
                <div class="panel-title">Spatial Indexing (Z-Order)</div>
                <div class="form-row group-input">
                    <input type="number" id="mx" placeholder="X" value="100">
                    <input type="number" id="my" placeholder="Y" value="200">
                    <input type="number" id="mz" placeholder="Z" value="50">
                    <button class="btn-primary" onclick="doMoCap()">Track</button>
                </div>
                <div style="font-size: 10px; color: var(--text-tertiary); margin-top: 4px;">Maps 3D coordinates to 1D Linear Key</div>
            </div>

            <div class="panel">
                <div class="panel-title">Read Operations</div>
                <div class="form-row group-input" style="margin-bottom: 12px;">
                    <input type="number" id="getKey" placeholder="Point Lookup ID...">
                    <button onclick="doGet()">Get</button>
                </div>
                
                <div class="panel-title" style="margin-top: 15px; font-size: 11px; color: var(--text-secondary);">RANGE SCAN</div>
                <div class="form-row group-input">
                    <input type="number" id="scanStart" placeholder="Start Key">
                    <input type="number" id="scanEnd" placeholder="End Key">
                    <button onclick="doScan()">Scan</button>
                </div>
            </div>

            <div class="panel">
                <div class="panel-title">Kernel Admin</div>
                <div class="form-row">
                    <button class="btn-block" onclick="downloadCSV()">Export Model CSV</button>
                </div>
                <button class="btn-block btn-danger" onclick="resetDB()">Reset Kernel State</button>
            </div>
        </div>

        <div class="col-right">
            
            <div class="panel">
                <div class="panel-title">
                    Latency Benchmark
                    <span id="speedupVal" style="color: var(--success); font-family: var(--font-mono);">0.00x Speedup</span>
                </div>
                <div class="bench-row">
                    <div class="bench-label">B-Tree</div>
                    <div class="bench-track"><div class="bench-fill" id="barB"></div></div>
                    <div class="bench-val" id="valB">--</div>
                </div>
                <div class="bench-row">
                    <div class="bench-label" style="color: var(--success);">NeuroDB</div>
                    <div class="bench-track"><div class="bench-fill neuro" id="barAI"></div></div>
                    <div class="bench-val" id="valAI">--</div>
                </div>
                <button class="btn-primary btn-block" onclick="runBenchmark()" id="btnBench" style="margin-top:10px;">Execute Performance Test</button>
            </div>

            <div class="panel">
                <div class="panel-title">
                    Learned Index Error Heatmap
                    <button onclick="loadHeatmap()" style="font-size: 10px; padding: 2px 8px; margin: 0; width: auto;">Refresh</button>
                </div>
                <canvas id="heatCanvas" width="800" height="200"></canvas>
                <div style="font-size:10px; color:var(--text-tertiary); margin-top:4px; text-align: center;">
                    X-Axis: Key Space | Y-Axis: Prediction Error (Center = 0)
                </div>
            </div>

            <div class="terminal" id="console">
                <div class="log-line"><span class="ts">SYSTEM</span><span class="msg-sys">Kernel initialized. Backend: Custom WAL. Shards: 16.</span></div>
            </div>
        </div>
    </div>

    <script>
        // --- Core Utilities ---
        function log(msg, type = 'info') {
            const el = document.getElementById('console');
            const now = new Date().toISOString().split('T')[1].slice(0,8);
            let cls = 'msg-info';
            if (type === 'err') cls = 'msg-error';
            if (type === 'ok') cls = 'msg-success';
            if (type === 'sys') cls = 'msg-sys';
            
            const row = document.createElement('div');
            row.className = 'log-line';
            row.innerHTML = `<span class="ts">${now}</span><span class="${cls}">${msg}</span>`;
            el.appendChild(row);
            el.scrollTop = el.scrollHeight;
        }

        // --- Metrics Polling ---
        async function updateStats() {
            try {
                const res = await fetch('/api/stats');
                if (!res.ok) return;
                const data = await res.json();
                
                document.getElementById('memVal').innerText = data.memtable_record_count.toLocaleString();
                document.getElementById('modelVal').innerText = data.learned_indexes_count;
                document.getElementById('rwVal').innerText = parseFloat(data.rw_ratio).toFixed(2);
                document.getElementById('shardVal').innerText = data.shards_active || "--"; // New Shard Metric
                
                // WAL Buffer Queue
                const queueSize = data.pending_writes || 0;
                const qEl = document.getElementById('queueVal');
                qEl.innerText = queueSize.toLocaleString();
                
                // Visual Alert for Queue Backpressure
                if (queueSize > 2000) qEl.style.color = '#da3633'; // Red
                else if (queueSize > 500) qEl.style.color = '#d29922'; // Yellow
                else qEl.style.color = '#1f6feb'; // Blue

                const modeEl = document.getElementById('modeVal');
                if (data.mode && data.mode.includes("AI")) {
                    modeEl.innerText = "AI-Optimized";
                    modeEl.style.color = "var(--success)";
                } else {
                    modeEl.innerText = "Write-Heavy";
                    modeEl.style.color = "var(--text-primary)";
                }
            } catch(e) {}
        }
        setInterval(updateStats, 1000);

        // --- Write Operations ---
        async function doPut() {
            const k = parseInt(document.getElementById('putKey').value);
            const v = document.getElementById('putVal').value || "val";
            if(isNaN(k)) return;
            try {
                await fetch('/api/put', { method:'POST', body: JSON.stringify({key:k, value:v})});
                log(`Write: Key=${k} (To WAL)`, 'ok');
                document.getElementById('putKey').value = k+1;
            } catch(e) { log("Put failed: " + e, 'err'); }
        }

        async function triggerIngest() {
            if(!confirm("Initiate batch ingestion (50k records)? This will test WAL throughput.")) return;
            log("Starting high-throughput ingestion...", 'sys');
            try {
                await fetch('/api/ingest', { method:'POST'});
                setTimeout(() => log("Ingestion running in background (Check WAL Buffer)...", 'sys'), 1000);
            } catch(e) { log(e, 'err'); }
        }

        async function doMoCap() {
            const x = parseInt(document.getElementById('mx').value);
            const y = parseInt(document.getElementById('my').value);
            const z = parseInt(document.getElementById('mz').value);
            try {
                const res = await fetch('/api/mocap/put', { method:'POST', body: JSON.stringify({x,y,z, data:"Frame"})});
                const d = await res.json();
                log(`Spatial Index: (${x},${y},${z}) -> Z-Key: ${d.spatial_key}`, 'sys');
                // Auto increment for easier testing
                document.getElementById('mx').value = x+1;
            } catch(e) { log(e, 'err'); }
        }

        // --- Read Operations ---
        async function doGet() {
            const k = document.getElementById('getKey').value;
            if(!k) return;
            try {
                const res = await fetch(`/api/get?key=${k}`);
                const d = await res.json();
                if(res.ok) log(`Query Hit: Key=${k} (${d.latency_ns}ns)`, 'ok');
                else log(`Query Miss: Key=${k}`, 'err');
            } catch(e) { log(`Error querying key ${k}`, 'err'); }
        }

        async function doScan() {
            const s = document.getElementById('scanStart').value;
            const e = document.getElementById('scanEnd').value;
            if(!s || !e) return;
            
            log(`Scanning range [${s}, ${e}] across shards...`, 'sys');
            try {
                const res = await fetch(`/api/scan?start=${s}&end=${e}`);
                const d = await res.json();
                log(`Scan Result: Found ${d.count} records.`, 'ok');
                if(d.count > 0 && d.count < 20) {
                     const keys = d.data.map(r => r.Key).join(", ");
                     log(`> Keys: [${keys}]`, 'info');
                }
            } catch(e) { log(e, 'err'); }
        }

        // --- Visualization & Benchmarks ---
        async function runBenchmark() {
            const btn = document.getElementById('btnBench');
            const originalText = btn.innerText;
            btn.innerText = "Running Test..."; btn.disabled = true;
            try {
                const res = await fetch('/api/benchmark');
                const d = await res.json();
                
                document.getElementById('valB').innerText = d.btree_avg_ns;
                document.getElementById('valAI').innerText = d.ai_avg_ns;
                document.getElementById('speedupVal').innerText = d.speedup + " Speedup";
                
                const valB = parseFloat(d.btree_avg_ns);
                const valAI = parseFloat(d.ai_avg_ns);
                const max = Math.max(valB, valAI);
                
                document.getElementById('barB').style.width = (valB/max*100) + "%";
                document.getElementById('barAI').style.width = (valAI/max*100) + "%";
                
                log(`Benchmark: ${d.speedup} speedup achieved.`, 'sys');
            } catch(e) { log(e, 'err'); }
            finally { btn.innerText = originalText; btn.disabled = false; }
        }

        async function loadHeatmap() {
            const cvs = document.getElementById('heatCanvas');
            const ctx = cvs.getContext('2d');
            const W = cvs.width;
            const H = cvs.height;

            // Clear & Draw Axis
            ctx.fillStyle = '#010409';
            ctx.fillRect(0,0,W,H);
            ctx.strokeStyle = '#30363d';
            ctx.lineWidth = 1;
            ctx.beginPath(); ctx.moveTo(0, H/2); ctx.lineTo(W, H/2); ctx.stroke();

            try {
                log("Fetching model diagnostics...", 'info');
                const res = await fetch('/api/heatmap');
                const data = await res.json();
                
                if(!data || data.length === 0) {
                    log("No model data available (Try inserting >50k records)", 'err');
                    return;
                }

                const minK = data[0].k;
                const maxK = data[data.length-1].k;
                const rangeK = maxK - minK || 1;

let maxErrAbs = 0;
data.forEach(p => {
    const absE = Math.abs(p.e);
    if (absE > maxErrAbs) maxErrAbs = absE;
});

if (maxErrAbs === 0) maxErrAbs = 1;

const scaleFactor = ((H / 2) / maxErrAbs) * 0.9;

data.forEach(p => {
    const x = ((p.k - minK) / rangeK) * W;
    
    let y = (H/2) - (p.e * scaleFactor);

    if(y < 0) y = 0;
    if(y > H) y = H;

    const errMag = Math.abs(p.e);
    if(errMag < 5) ctx.fillStyle = '#238636';     
    else if(errMag < 20) ctx.fillStyle = '#d29922'; 
    else ctx.fillStyle = '#da3633';                 

    ctx.fillRect(x, y, 2, 2);
});
                log(`Heatmap updated with ${data.length} points (Sampled from active shard).`, 'ok');

            } catch(e) { log("Error loading heatmap: " + e, 'err'); }
        }

        // --- Admin ---
        function downloadCSV() { window.location.href = "/api/export"; }
        
        async function resetDB() {
            if(!confirm("WARNING: This will wipe the WAL and reset all shards. Continue?")) return;
            try {
                await fetch('/api/reset');
                log("Kernel & WAL reset successfully.", 'sys');
                document.getElementById('valB').innerText = "--";
                document.getElementById('valAI').innerText = "--";
                const cvs = document.getElementById('heatCanvas');
                cvs.getContext('2d').clearRect(0,0,cvs.width,cvs.height);
                updateStats();
            } catch(e) { log(e, 'err'); }
        }
    </script>
</body>
</html>