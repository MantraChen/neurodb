<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroDB Control Plane</title>
    <style>
        :root {
            /* Professional Dark Palette (Inspired by GitHub/Linear) */
            --bg-body: #0d1117;
            --bg-card: #161b22;
            --bg-input: #010409;
            --border-color: #30363d;
            --border-hover: #8b949e;
            
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;

            --accent-primary: #1f6feb; /* Professional Blue */
            --accent-success: #238636; /* Success Green */
            --accent-warning: #d29922; /* Warning Orange */
            --accent-danger: #da3633;  /* Danger Red */
            
            --font-ui: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            --font-mono: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-body);
            color: var(--text-primary);
            font-family: var(--font-ui);
            margin: 0;
            padding: 40px;
            font-size: 14px;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }
        
        .version-tag {
            font-family: var(--font-mono);
            font-size: 12px;
            color: var(--text-secondary);
            margin-left: 10px;
            padding: 2px 6px;
            background: var(--border-color);
            border-radius: 4px;
        }

        .status-indicator {
            font-size: 12px;
            color: var(--text-secondary);
            font-family: var(--font-mono);
        }
        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: var(--accent-success);
            border-radius: 50%;
            margin-right: 6px;
        }

        /* Dashboard Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 32px;
        }

        .metric-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 20px;
        }

        .metric-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .metric-value {
            font-family: var(--font-mono);
            font-size: 24px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .metric-sub {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Main Layout */
        .layout-split {
            display: grid;
            grid-template-columns: 360px 1fr;
            gap: 24px;
        }

        /* Control Panels */
        .panel {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .panel-header {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
        }

        /* Inputs & Buttons */
        .input-group {
            display: flex;
            gap: -1px; /* Merge borders */
            margin-bottom: 12px;
        }

        input {
            flex: 1;
            min-width: 0;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 12px;
            font-family: var(--font-mono);
            font-size: 13px;
            border-radius: 6px 0 0 6px;
            outline: none;
            transition: border-color 0.2s;
        }
        
        input:focus {
            border-color: var(--accent-primary);
            z-index: 2;
        }

        /* Spatial Inputs Fix */
        .spatial-group input {
            border-radius: 0;
            text-align: center;
        }
        .spatial-group input:first-child { border-radius: 6px 0 0 6px; }

        button {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 0 6px 6px 0;
            white-space: nowrap;
            transition: all 0.2s;
            margin-left: -1px;
        }

        button:hover:not(:disabled) {
            background: #21262d;
            border-color: var(--border-hover);
        }
        
        button:active:not(:disabled) { transform: translateY(1px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-full {
            width: 100%;
            border-radius: 6px;
            margin: 8px 0 0 0;
            justify-content: center;
        }

        /* Button Variants */
        .btn-primary { color: var(--accent-primary); border-color: var(--border-color); }
        .btn-primary:hover { border-color: var(--accent-primary); background: rgba(31, 111, 235, 0.1); }
        
        .btn-danger { color: var(--accent-danger); border-color: var(--border-color); }
        .btn-danger:hover { border-color: var(--accent-danger); background: rgba(218, 54, 51, 0.1); }

        /* Benchmark Section */
        .benchmark-container {
            padding: 0;
        }
        
        .bench-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            font-size: 13px;
        }
        
        .bench-label { width: 80px; color: var(--text-secondary); }
        
        .bench-track {
            flex: 1;
            height: 6px;
            background: #21262d;
            border-radius: 3px;
            margin: 0 16px;
            overflow: hidden;
        }
        
        .bench-bar {
            height: 100%;
            width: 0%;
            border-radius: 3px;
            transition: width 0.6s ease-out;
        }

        .bench-val {
            width: 80px;
            text-align: right;
            font-family: var(--font-mono);
            color: var(--text-secondary);
        }

        /* Logs */
        .log-container {
            background: #010409;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            height: 300px;
            overflow-y: auto;
            padding: 12px;
            font-family: var(--font-mono);
            font-size: 12px;
        }

        .log-entry {
            margin-bottom: 6px;
            border-bottom: 1px solid #161b22;
            padding-bottom: 2px;
        }
        .ts { color: var(--text-muted); margin-right: 12px; }
        .l-info { color: var(--text-primary); }
        .l-err { color: var(--accent-danger); }
        .l-succ { color: var(--accent-success); }
        .l-warn { color: var(--accent-warning); }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                NeuroDB
                <span class="version-tag">v2.0-Spatial</span>
            </h1>
            <div class="status-indicator">
                <span class="status-dot"></span>System Operational
            </div>
        </header>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Workload Mode</div>
                <div class="metric-value" id="mode" style="font-size: 18px;">Initializing...</div>
                <div class="metric-sub">Optimizer Status</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">MemTable Records</div>
                <div class="metric-value" id="memSize">0</div>
                <div class="metric-sub">Sharded Buffer</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Learned Models</div>
                <div class="metric-value" id="learnedCount">0</div>
                <div class="metric-sub">RMI Segments</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">R/W Ratio</div>
                <div class="metric-value" id="ratio">0.00</div>
                <div class="metric-sub">Bloom Filter: <span id="bloomStatus" style="color: var(--text-muted)">Ready</span></div>
            </div>
        </div>

        <div class="layout-split">
            <div>
                <div class="panel">
                    <div class="panel-header">Key-Value Injection</div>
                    <div class="input-group">
                        <input type="number" id="writeKey" placeholder="ID">
                        <input type="text" id="writeVal" placeholder="Payload">
                        <button onclick="doPut()">Put</button>
                    </div>
                    <button class="btn-full" onclick="triggerIngest()">Auto Ingest 50k</button>
                </div>

                <div class="panel">
                    <div class="panel-header">Spatial Engine (MoCap)</div>
                    <div class="input-group spatial-group">
                        <input type="number" id="mx" placeholder="X" value="100">
                        <input type="number" id="my" placeholder="Y" value="200">
                        <input type="number" id="mz" placeholder="Z" value="50">
                        <button class="btn-primary" onclick="doMoCap()">Track</button>
                    </div>
                    <div class="metric-sub" style="text-align: center; margin-top: 8px;">
                        Z-Order Curve Encoding
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">Point Lookup</div>
                    <div class="input-group">
                        <input type="number" id="readKey" placeholder="Search Key ID...">
                        <button onclick="doGet()">Query</button>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">Data Management</div>
                    <button class="btn-full" onclick="downloadCSV()">Export Experiment CSV</button>
                    <button class="btn-full btn-danger" onclick="resetDB()" style="margin-top: 12px;">Reset Database</button>
                </div>
            </div>

            <div>
                <div class="panel benchmark-container">
                    <div class="panel-header">
                        Latency Benchmark
                        <span id="benchSpeed" style="color: var(--accent-success); font-family: var(--font-mono);">0.0x Speedup</span>
                    </div>

                    <div class="bench-row">
                        <div class="bench-label">B-Tree</div>
                        <div class="bench-track"><div class="bench-bar" id="barB" style="background: var(--text-secondary);"></div></div>
                        <div class="bench-val" id="valB">--</div>
                    </div>

                    <div class="bench-row">
                        <div class="bench-label" style="color: var(--accent-success); font-weight: 600;">NeuroDB</div>
                        <div class="bench-track"><div class="bench-bar" id="barAI" style="background: var(--accent-success);"></div></div>
                        <div class="bench-val" id="valAI" style="color: var(--accent-success);">--</div>
                    </div>

                    <button class="btn-full btn-primary" onclick="runBenchmark()" id="btnBench" style="margin-top: 20px;">
                        Run Performance Test
                    </button>
                </div>

                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span class="metric-label">System Kernel Logs</span>
                    <button onclick="clearLog()" style="background: none; border: none; padding: 0; font-size: 11px; color: var(--text-secondary);">Clear</button>
                </div>
                <div id="log" class="log-container">
                    <div class="log-entry"><span class="ts">SYSTEM</span>Kernel initialized. Ready.</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function log(msg, type = 'info') {
            const el = document.getElementById('log');
            const time = new Date().toLocaleTimeString('en-US', {hour12: false});
            let className = 'l-info';
            if (type === 'error') className = 'l-err';
            if (type === 'success') className = 'l-succ';
            if (type === 'warn') className = 'l-warn';
            
            el.innerHTML += `<div class="log-entry ${className}"><span class="ts">${time}</span>${msg}</div>`;
            el.scrollTop = el.scrollHeight;
        }

        function clearLog() { document.getElementById('log').innerHTML = ''; }

        async function updateStats() {
            try {
                const res = await fetch('/api/stats');
                const data = await res.json();
                
                const modeEl = document.getElementById('mode');
                if (data.mode.includes("AI")) {
                    modeEl.innerText = "AI-Optimized";
                    modeEl.style.color = "var(--accent-success)";
                } else {
                    modeEl.innerText = "LSM-Write";
                    modeEl.style.color = "var(--text-primary)";
                }

                document.getElementById('memSize').innerText = data.memtable_record_count.toLocaleString();
                document.getElementById('learnedCount').innerText = data.learned_indexes_count;
                document.getElementById('ratio').innerText = parseFloat(data.rw_ratio).toFixed(2);
                
                const bloomEl = document.getElementById('bloomStatus');
                if (data.bloom_bits > 0) {
                    bloomEl.innerText = "Active";
                    bloomEl.style.color = "var(--accent-success)";
                }

            } catch (e) { /* silent fail */ }
        }

        async function doPut() {
            const k = parseInt(document.getElementById('writeKey').value);
            const v = document.getElementById('writeVal').value;
            if (!k || !v) return;
            try {
                await fetch('/api/put', { method: 'POST', body: JSON.stringify({key: k, value: v}) });
                log(`Write OK: Key=${k}`, 'success');
                document.getElementById('writeKey').value = k + 1;
            } catch (e) { log(e, 'error'); }
        }

        async function doMoCap() {
            const x = parseInt(document.getElementById('mx').value);
            const y = parseInt(document.getElementById('my').value);
            const z = parseInt(document.getElementById('mz').value);
            
            try {
                const res = await fetch('/api/mocap/put', {
                    method: 'POST',
                    body: JSON.stringify({x, y, z, data: "Frame_Data"})
                });
                const data = await res.json();
                if (data.error) throw data.error;

                log(`Spatial Index: (${x},${y},${z}) -> Z-Key: ${data.spatial_key}`, 'success');
                document.getElementById('mx').value = x + 1;
            } catch (e) { log(e, 'error'); }
        }

        async function doGet() {
            const k = document.getElementById('readKey').value;
            if (!k) return;
            try {
                const res = await fetch(`/api/get?key=${k}`);
                if (res.ok) {
                    const data = await res.json();
                    log(`Query Hit: Key=${k} (${data.latency_ns}ns)`, 'success');
                } else {
                    log(`Query Miss: Key=${k} (Filtered)`, 'warn');
                }
            } catch (e) { log(e, 'error'); }
        }

        async function triggerIngest() {
            if (!confirm("Start background ingestion (50k records)?")) return;
            log("Starting ingestion workload...", 'info');
            const btn = document.querySelector('button[onclick="triggerIngest()"]');
            btn.disabled = true; btn.innerText = "Processing...";

            try {
                await fetch('/api/ingest', { method: 'POST' });
                setTimeout(() => {
                    btn.disabled = false; btn.innerText = "Auto Ingest 50k";
                    log("Ingestion batch complete.", 'success');
                }, 4000);
            } catch (e) { log(e, 'error'); btn.disabled = false; }
        }

        function downloadCSV() {
            window.location.href = "/api/export";
            log("Exporting CSV dataset...", 'info');
        }

        async function resetDB() {
            if (!confirm("Are you sure you want to delete all data?")) return;
            log("Resetting database...", 'warn');
            try {
                await fetch('/api/reset');
                log("System reset complete.", 'success');
                document.getElementById('barB').style.width = "0%";
                document.getElementById('barAI').style.width = "0%";
                document.getElementById('benchSpeed').innerText = "0.0x Speedup";
                updateStats();
            } catch (e) { log(e, 'error'); }
        }

        async function runBenchmark() {
            const btn = document.getElementById('btnBench');
            btn.innerText = "Running..."; btn.disabled = true;

            try {
                const res = await fetch('/api/benchmark');
                const data = await res.json();
                if (data.error) { alert(data.error); return; }

                const valB = parseFloat(data.btree_avg_ns);
                const valAI = parseFloat(data.ai_avg_ns);
                
                document.getElementById('valB').innerText = data.btree_avg_ns;
                document.getElementById('valAI').innerText = data.ai_avg_ns;
                document.getElementById('benchSpeed').innerText = data.speedup + " Speedup";

                const max = Math.max(valB, valAI);
                document.getElementById('barB').style.width = (valB / max * 100) + "%";
                document.getElementById('barAI').style.width = (valAI / max * 100) + "%";

                log(`Benchmark Result: ${data.speedup} speedup`, 'success');
            } catch (e) { log(e, 'error'); } 
            finally { btn.innerText = "Run Performance Test"; btn.disabled = false; }
        }

        setInterval(updateStats, 1000);
        updateStats();
    </script>
</body>
</html>